<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: routes/api/search_manager.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: routes/api/search_manager.js</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>/** Handles search logic and search history
 * @module search_manager
 * @requires express
 * @requires database_api
 */
const express = require('express');
const database = require('../../database_api');

const router = express.Router();

/**
 * For fuzzy search
 */
/**
 *
 * @param {*} text - String user enters to search
 * @returns {String} String with wildcards
 */
function escapeRegex(text) {
  return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&amp;');
}

/**
 * POST: Search for a specific carparks
 * @name /search
 * @function
 * @inner
 * @param {string} req - Request
 * @param {string} res - Response
 */
router.post('/search', async (req, res) => {
  //fuzzy search
  const regex = new RegExp(escapeRegex(req.body.ppName), 'gi');
  const carpark_details = database.connectCollection('carpark_details');
  updateSearchHistory(req.body.ppName);
  res.send(await carpark_details.find({ ppName: regex }).toArray());
});

/**
 * GET: User's 10 recent search history
 * @name /ush
 * @function
 * @inner
 * @param {string} res - Response
 */
router.get('/ush', async (req, res) => {
  const user_history = database.connectCollection('user_history');
  res.send(await user_history.find({}).sort({ createdAt: 1 }).toArray());
});

/**
 * POST: Find carpark details
 * @name /recentcarparks
 * @function
 * @inner
 * @param {string} req - Request
 * @param {string} res - Response
 */
router.post('/recentcarparks', async (req, res) => {
  const carpark_details = database.connectCollection('carpark_details');
  res.send(await carpark_details.find({ ppName: { $in: req.body.content.carparks } }).toArray());
});

/**
 * Update User's search history
 * @param {*} search - What the user has just searched for
 */
async function updateSearchHistory(search) {
  const user_history = database.connectCollection('user_history');
  await user_history.insertOne({
    text: search,
    createdAt: new Date(),
  });

  console.log("User's history updated");
}

module.exports = router;
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Modules</h3>
      <ul>
        <li><a href="module-api_helper.html">api_helper</a></li>
        <li><a href="module-app.html">app</a></li>
        <li><a href="module-carpark_manager.html">carpark_manager</a></li>
        <li><a href="module-search_manager.html">search_manager</a></li>
        <li><a href="module-users_manager.html">users_manager</a></li>
      </ul>
      <h3>Classes</h3>
      <ul>
        <li><a href="DatabaseAPI.html">DatabaseAPI</a></li>
        <li><a href="URAAPI.html">URAAPI</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Sat Mar 26 2022 16:05:03
      GMT+0800 (Singapore Standard Time)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
